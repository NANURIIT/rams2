<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nanuri.rams.business.common.mapper.IBIMS403BMapper">

    <select id="selectIBIMS403BList" parameterType="com.nanuri.rams.business.common.vo.IBIMS403BVO" resultType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
           SELECT
                  PRDT_CD                                 <!-- /*상품코드 */ -->
                , EXC_SN                                  <!-- /*실행일련번호 */ -->
                , #{trSn} AS HGRK_TR_SN                   <!-- /*사거래일련번호 */ -->
                , TR_SN                                   <!-- /*거래일련번호 */ -->
                , SCX_DCD                                 <!-- /*일정구분코드 */ -->
                , RDMP_TMRD                               <!-- /*상환회차 */ -->
                , PRAR_DT                                 <!-- /*예정일자 */ -->
                , PRAR_PRNA                               <!-- /*예정원금 */ -->
                , STRT_DT                                 <!-- /*시작일자 */ -->
                , END_DT                                  <!-- /*종료일자 */ -->
                , RDMP_PRAR_INTR                          <!-- /*상환예정이자 */ -->
                , PRCS_CPLT_YN                            <!-- /*처리완료여부 */ -->
                , PRCS_DT                                 <!-- /*처리일자 */ -->
                , PRCS_AMT                                <!-- /*처리금액 */ -->
                , PRCS_INTR_AMT                           <!-- /*처리이자금액 */ -->
                , APLY_IRT                                <!-- /*적용이율 */ -->
                , OVDU_INTR_RT                            <!-- /*연체이자율 */ -->
                , TRCH_DCD                                <!-- /*트렌치구분코드 */ -->
                , HND_DETL_DTM                            <!-- /*조작상세일시 */ -->
                , HND_EMPNO                               <!-- /*조작사원번호 */ -->
                , HND_TMNL_NO                             <!-- /*조작단말기번호 */ -->
                , HND_TR_ID                               <!-- /*조작거래id */ -->
                , GUID                                    <!-- /*guid */ -->
             FROM IBIMS403B
            WHERE PRDT_CD = #{prdtCd}        /* 상품코드 */
              AND EXC_SN  = #{excSn}         /* 실행일련번호 */
    </select>
    <select id="getExcSn" resultType="long" parameterType="string">
		SELECT 
		       NVL(MAX(A.EXC_SN),0)+1 AS EXC_SN				/* 실행일련번호 채번 */
		  FROM IBIMS403B A 	/* 여신스케쥴기본 */
		 WHERE 1 = 1
		   AND A.PRDT_CD =  #{prdtCd} /*  'A000000001' */
    </select>
    
    <!-- /*여신스케쥴기본등록 */  -->
    <insert id="saveRdmpInfo" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
        INSERT INTO IBIMS403B
               (
                  PRDT_CD                                 <!-- /*상품코드 */ -->
                , EXC_SN                                  <!-- /*실행일련번호 */ -->
                , SCX_DCD                                 <!-- /*일정구분코드 */ -->
                , RDMP_TMRD                               <!-- /*상환회차 */ -->
                , PRAR_DT                                 <!-- /*예정일자 */ -->
                , PRAR_PRNA                               <!-- /*예정원금 */ -->
                , STRT_DT                                 <!-- /*시작일자 */ -->
                , END_DT                                  <!-- /*종료일자 */ -->
                , RDMP_PRAR_INTR                          <!-- /*상환예정이자 */ -->
                , PRCS_CPLT_YN                            <!-- /*처리완료여부 */ -->
                , PRCS_DT                                 <!-- /*처리일자 */ -->
                , PRCS_AMT                                <!-- /*처리금액 */ -->
                , PRCS_INTR_AMT                           <!-- /*처리이자금액 */ -->
                , APLY_IRT                                <!-- /*적용이율 */ -->
                , OVDU_INTR_RT                            <!-- /*연체이자율 */ -->
                , TRCH_DCD                                <!-- /*트렌치구분코드 */ -->
                , TR_SN                                   <!-- /*거래일련번호 */ -->
                , HND_DETL_DTM                            <!-- /*조작상세일시 */ -->
                , HND_EMPNO                               <!-- /*조작사원번호 */ -->
                , HND_TMNL_NO                             <!-- /*조작단말기번호 */ -->
                , HND_TR_ID                               <!-- /*조작거래id */ -->
                , GUID                                    <!-- /*guid */ -->
               )
        VALUES
        <foreach collection="list" item="item" separator=",">
               (
                 #{item.prdtCd}                           <!-- /*상품코드 */ -->
               , #{item.excSn}                            <!-- /*실행일련번호 */ -->
               , #{item.scxDcd}                           <!-- /*일정구분코드 */ -->
               , #{item.rdmpTmrd}                         <!-- /*상환회차 */ -->
               , #{item.prarDt}                           <!-- /*예정일자 */ -->
               , #{item.prarPrna}                         <!-- /*예정원금 */ -->
               , #{item.strtDt}                           <!-- /*시작일자 */ -->
               , #{item.endDt}                            <!-- /*종료일자 */ -->
               , #{item.rdmpPrarIntr}                     <!-- /*상환예정이자 */ -->
               , #{item.prcsCpltYn}                       <!-- /*처리완료여부 */ -->
               , #{item.prcsDt}                           <!-- /*처리일자 */ -->
               , #{item.prcsAmt}                          <!-- /*처리금액 */ -->
               , #{item.prcsIntrAmt}                      <!-- /*처리이자금액 */ -->
               , #{item.aplyIrt}                          <!-- /*적용이율 */ -->
               , #{item.ovduIntrRt}                       <!-- /*연체이자율 */ -->
               , #{item.trchDcd}                          <!-- /*트렌치구분코드 */ -->
               , #{item.trSn}                             <!-- /*거래일련번호 */ -->
               , SYSDATE                                    <!-- /*조작상세일시 */ -->
               , #{item.hndEmpno}                         <!-- /*조작사원번호 */ -->
               , #{item.hndTmnlNo}                        <!-- /*조작단말기번호 */ -->
               , #{item.hndTrId}                          <!-- /*조작거래id */ -->
               , #{item.guid}                             <!-- /*guid */ -->
               )
        </foreach>
    </insert>

    <select id="getRdmpList" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO" resultType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
		SELECT C.PRDT_CD            /* 상품코드 */
		     , C.EXC_SN             /* 실행일련번호 */
		     , A.PRAR_DT  			/* 상환예정일자 */
		     , C.EXP_DT             /* 만기일자 */
		     , C.DEAL_EXC_BLCE      /* 실행잔액 */
		     , A.PRAR_PRNA-A.PRCS_AMT AS PRAR_PRNA         /* 상환원금 */
		     , A.RDMP_PRAR_INTR     /* 상환이자 */
             , 0 AS DEAL_MRDP_PRCA  /* 딜중도상환원금 */                      
             , 0 AS MRDP_FEE_AMT    /* 중도상환수수료금액 */                   
             , 0 AS RCVB_INTR_AMT   /* 미수이자금액 */       
             , '0' AS MRDP_YN 	    /* 중도상환여부 */
             , NVL(D.MDWY_RDMP_FEE_RTO, 0) AS MDWY_RDMP_FEE_RTO  /* 중도상환수수료비율 */
		  FROM IBIMS401B B       /* 여신기본 */
             , IBIMS402B C  /* 실행기본 */
             , (
              SELECT PRDT_CD
                   , EXC_SN 
                   , MIN(PRAR_DT) AS PRAR_DT 				/* 예정일자 */
                   , SUM(NVL(PRAR_PRNA,0)) AS PRAR_PRNA	/* 예정원금 */
                   , SUM(NVL(PRCS_AMT,0)) AS PRCS_AMT 	/* 처리금액 */
                   , SUM(RDMP_PRAR_INTR) AS RDMP_PRAR_INTR 	/* 상환예정이자 */
                FROM IBIMS403B   /* 여신스케줄기본 */
               WHERE PRDT_CD     = #{prdtCd}                    
                 AND PRAR_DT &lt;= #{prarDt}  /* 상환일자 */
                 AND NVL(PRCS_CPLT_YN, '0') = '0' 
               GROUP BY PRDT_CD
                      , EXC_SN 
             ) A
 			, IBIMS204B D /* 딜승인중도상환수수료설정기본 */
           
	     WHERE 1 = 1
	       AND C.PRDT_CD = B.PRDT_CD
	       AND C.PRDT_CD = A.PRDT_CD(+)  
		   AND C.EXC_SN  = A.EXC_SN(+)
		   AND B.PRDT_CD = D.PRDT_CD(+) 
           AND D.FEE_SN(+)   = NVL(( SELECT MAX(FEE_SN) FEE_SN 
								   FROM IBIMS204B
								  WHERE PRDT_CD       = #{prdtCd}    
				   				    AND APLY_MNUM &lt;= (SELECT MONTHS_BETWEEN( SYSDATE, TO_DATE(V.CTRC_DT,'YYYYMMDD')) FROM IBIMS401B V WHERE PRDT_CD = #{prdtCd})     
						             ), 0)
		   AND B.PRDT_CD = #{prdtCd}     
		   AND B.CTRC_CCLC_DCD = '1'   
		   AND C.LDG_STTS_CD   = '1' 
	     ORDER BY C.PRDT_CD 
	            , C.EXC_SN 
    </select>

    <select id="getRdmpDetail" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO" resultType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
  SELECT  
	           A.PRDT_CD                    /* 상품코드 */
             , A.EXC_SN                     /* 실행일련번호 */
             , A.PRAR_DT                     /* 예정일자 */
             , CASE WHEN A.SCX_DCD = '02' THEN '1' /*원금 */
                    WHEN A.SCX_DCD = '04' THEN '2' /*정상이자 */                       
                    ELSE '99'
               END AS BSS_TYP_VAL            /* 원리금유형코드 */             
             , CASE WHEN A.SCX_DCD = '02' THEN
                        CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN '1' /*원금 */
                             ELSE '5'  /*원금연체금액 */
                        END
                    WHEN A.SCX_DCD = '04' THEN
                        CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN '2' /*정상이자 */
                             ELSE '4'  /*납부이자연체금액 */
                        END                         
                    ELSE '99'
               END AS PAI_TYP_CD            /* 원리금유형코드 */
            , CASE WHEN A.SCX_DCD = '02' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN 4 /*원금 */
                            ELSE 3  /*원금연체금액 */
                       END
                   WHEN A.SCX_DCD = '04' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN 2 /*정상이자 */
                            ELSE 1  /*납부이자연체금액 */
                       END                         
                   ELSE 5
              END AS PAI_TYP_VAL             /* 원리금유형코드 */                     
             , A.RDMP_TMRD                  /* 상환회차 */
             , A.SCX_DCD                    /* 일정구분코드 */
             , A.STRT_DT                    /* 시작일자 */
             , A.END_DT                     /* 종료일자 */
             , CASE WHEN LENGTH(A.END_DT)=8 AND LENGTH(A.STRT_DT)=8  THEN (TO_DATE(A.END_DT,'YYYYMMDD')-TO_DATE(A.STRT_DT,'YYYYMMDD'))+1 
               ELSE 0 END  AS INTR_APLY_DNUM /* 이자적용일수 */
             , NVL(B.FXN_INTRT,0)+NVL(B.ADD_INTRT,0) AS APLY_IRT /* 적용이율 */
             , NVL(
               CASE WHEN A.SCX_DCD = '02' THEN A.PRAR_PRNA
                         WHEN A.SCX_DCD = '04' THEN A.RDMP_PRAR_INTR
                         ELSE 0
               END, 0) AS TRGT_AMT                 /* 대상금액 = 예정원금 or 상환예정이자 */
            , NVL(
               CASE WHEN A.SCX_DCD = '02' THEN A.PRAR_PRNA
                         WHEN A.SCX_DCD = '04' THEN A.RDMP_PRAR_INTR
                         ELSE 0
               END, 0) AS PMNT_AMT                 /* 납부금액 */
             , A.PRAR_PRNA                  /* 예정원금 */
             , 0 AS EXMPT_AMT               /* 면제금액 */ 
             , A.PRAR_DT					/* 예정일자 */ 
             , A.RDMP_PRAR_INTR				/* 상환예정이자 */	
             , NVL(A.PRCS_CPLT_YN, '0') AS PRCS_CPLT_YN	/* 처리완료여부 */
             , A.PRCS_INTR_AMT				/* 처리이자금액 */		
             , A.PRCS_DT					/* 처리일자 */		
             , A.OVDU_INTR_RT				/* 연체이자율 */	
             , A.TRCH_DCD                   /* 트렌치구분코드 */
             , A.TR_SN                      /* 거래일련번호 */	
		  FROM IBIMS403B  A /* 여신스케쥴기본 */
             , IBIMS404B  B /* 여신실행금리기본 */
		WHERE 1 = 1
	      AND A.PRDT_CD       = #{prdtCd}
	      AND A.EXC_SN          = #{excSn}
	      AND A.PRAR_DT &lt;= #{rkfrDt} /* 상환일자 */
	      AND NVL(PRCS_CPLT_YN, '0') = '0' 
	      AND #{dealMrdpPrca} &lt;= '0'			/* 중도상환금액이 없는경우 */
	      AND B.PRDT_CD = A.PRDT_CD 
	      AND B.EXC_SN  = A.EXC_SN 
		  AND A.PRAR_DT BETWEEN B.APLY_STRT_DT  AND  B.APLY_END_DT
		UNION ALL
	   SELECT 
	          A.PRDT_CD                     /* 상품코드 */
            , A.EXC_SN                      /* 실행일련번호 */
            , A.PRAR_DT                     /* 예정일자 */
            , CASE WHEN A.SCX_DCD = '02' THEN '1' /*원금 */
                   WHEN A.SCX_DCD = '04' THEN '2' /*정상이자 */                       
                   ELSE '99'
              END AS BSS_TYP_VAL            /* 원리금유형코드 */            
            , CASE WHEN A.SCX_DCD = '02' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN '1' /*원금 */
                            ELSE '5'  /*원금연체금액 */
                       END
                   WHEN A.SCX_DCD = '04' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN '2' /*정상이자 */
                            ELSE '4'  /*납부이자연체금액 */
                       END                         
                   ELSE '99'
              END AS PAI_TYP_CD             /* 원리금유형코드 */
            , CASE WHEN A.SCX_DCD = '02' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN 4 /*원금 */
                            ELSE 3  /*원금연체금액 */
                       END
                   WHEN A.SCX_DCD = '04' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN 2 /*정상이자 */
                            ELSE 1  /*납부이자연체금액 */
                       END                         
                   ELSE 5
              END AS PAI_TYP_VAL             /* 원리금유형코드 */                          
            , A.RDMP_TMRD                   /* 상환회차 */
            , A.SCX_DCD                     /* 일정구분코드 */
            , A.STRT_DT                     /* 시작일자 */
            , A.END_DT                      /* 종료일자 */
            , CASE WHEN LENGTH(A.END_DT)=8 AND LENGTH(A.STRT_DT)=8  THEN (TO_DATE(A.END_DT,'YYYYMMDD')-TO_DATE(A.STRT_DT,'YYYYMMDD'))+1 
               ELSE 0 END  AS INTR_APLY_DNUM /* 이자적용일수 */
            , NVL(B.FXN_INTRT,0)+NVL(B.ADD_INTRT,0) AS APLY_IRT /* 적용이율 */
            , NVL(
              CASE WHEN A.SCX_DCD = '02' THEN A.PRAR_PRNA
                       WHEN A.SCX_DCD = '04' THEN A.RDMP_PRAR_INTR
                       ELSE 0
               END, 0) AS TRGT_AMT                 /* 대상금액 = 예정원금 or 상환예정이자 */
            , NVL(
               CASE WHEN A.SCX_DCD = '02' THEN 0
                    WHEN A.SCX_DCD = '04' THEN A.RDMP_PRAR_INTR
                    ELSE 0
               END, 0) AS PMNT_AMT                      /* 납부금액 */         
            , A.PRAR_PRNA                   /* 예정원금 */
            , 0 AS EXMPT_AMT                /* 면제금액 */ 
            , A.PRAR_DT						/* 예정일자 */ 
            , A.RDMP_PRAR_INTR				/* 상환예정이자 */	
            , NVL(A.PRCS_CPLT_YN, '0') AS PRCS_CPLT_YN	/* 처리완료여부 */
            , A.PRCS_INTR_AMT				/* 처리이자금액 */		
            , A.PRCS_DT						/* 처리일자 */		
            , A.OVDU_INTR_RT				/* 연체이자율 */	
            , A.TRCH_DCD                    /* 트렌치구분코드 */
            , A.TR_SN                       /* 거래일련번호 */	
         FROM IBIMS403B  A /* 여신스케쥴기본 */
            , IBIMS404B  B /* 여신실행금리기본 */
		WHERE 1=1 
	      AND A.PRDT_CD   = #{prdtCd}
	      AND A.EXC_SN      = #{excSn}
	      AND A.SCX_DCD   = '04'
	      AND A.PRAR_DT &lt;= #{rkfrDt} /* 상환일자 */	      
	      AND NVL(PRCS_CPLT_YN, '0') = '0' 
	      AND #{dealMrdpPrca} &gt; 0 					/* 중도상환금액이 있는경우  */
	      AND B.PRDT_CD = A.PRDT_CD 
	      AND B.EXC_SN  = A.EXC_SN 
		  AND A.PRAR_DT BETWEEN B.APLY_STRT_DT  AND  B.APLY_END_DT    
	   UNION ALL 
	   SELECT 
	          A.PRDT_CD                     /* 상품코드 */
            , A.EXC_SN                      /* 실행일련번호 */
            , A.PRAR_DT                     /* 예정일자 */
            , CASE WHEN A.SCX_DCD = '02' THEN '1'  /*원금 */
                   WHEN A.SCX_DCD = '04' THEN '2'  /*정상이자 */                       
                   ELSE '99'
              END AS BSS_TYP_VAL            /* 원리금유형코드 */            
            , CASE WHEN A.SCX_DCD = '02' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN '1'  /*원금 */
                            ELSE '5'  /*원금연체금액 */
                       END
                   WHEN A.SCX_DCD = '04' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN '2'  /*정상이자 */
                            ELSE '4'   /*납부이자연체금액 */
                       END                         
                   ELSE '99'
              END AS PAI_TYP_CD             /* 원리금유형코드 */
            , CASE WHEN A.SCX_DCD = '02' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN 4  /*원금 */
                            ELSE 3   /*원금연체금액 */
                       END
                   WHEN A.SCX_DCD = '04' THEN
                       CASE WHEN A.PRAR_DT &gt;= #{rkfrDt} THEN 2  /*정상이자 */
                            ELSE 1   /*납부이자연체금액 */
                       END                         
                   ELSE 5
              END AS PAI_TYP_VAL             /* 원리금유형코드 */                          
            , A.RDMP_TMRD                   /* 상환회차 */
            , A.SCX_DCD                     /* 일정구분코드 */
            , A.STRT_DT                     /* 시작일자 */
            , A.END_DT                      /* 종료일자 */
            , CASE WHEN LENGTH(A.END_DT)=8 AND LENGTH(A.STRT_DT)=8  THEN (TO_DATE(A.END_DT,'YYYYMMDD')-TO_DATE(A.STRT_DT,'YYYYMMDD'))+1 
               ELSE 0 END  AS INTR_APLY_DNUM /* 이자적용일수 */
            , NVL(B.FXN_INTRT,0)+NVL(B.ADD_INTRT,0) AS APLY_IRT /* 적용이율 */
            , NVL(
              CASE WHEN A.SCX_DCD = '02' THEN A.PRAR_PRNA
                       WHEN A.SCX_DCD = '04' THEN A.RDMP_PRAR_INTR
                       ELSE 0
               END, 0) AS TRGT_AMT                 /* 대상금액 = 예정원금 or 상환예정이자 */
            , NVL(
               CASE WHEN A.SCX_DCD = '02' THEN 0
                    WHEN A.SCX_DCD = '04' THEN A.RDMP_PRAR_INTR
                    ELSE 0
               END, 0) AS PMNT_AMT                      /* 납부금액 */         
            , A.PRAR_PRNA                   /* 예정원금 */
            , 0 AS EXMPT_AMT                /* 면제금액 */ 
            , A.PRAR_DT						/* 예정일자 */ 
            , A.RDMP_PRAR_INTR				/* 상환예정이자 */	
            , NVL(A.PRCS_CPLT_YN, '0') AS PRCS_CPLT_YN	/* 처리완료여부 */
            , A.PRCS_INTR_AMT				/* 처리이자금액 */		
            , A.PRCS_DT						/* 처리일자 */		
            , A.OVDU_INTR_RT				/* 연체이자율 */	
            , A.TRCH_DCD                    /* 트렌치구분코드 */
            , A.TR_SN                       /* 거래일련번호 */	
         FROM IBIMS403B  A /* 여신스케쥴기본 */
            , IBIMS404B  B /* 여신실행금리기본 */
		WHERE 1=1 
	      AND A.PRDT_CD = #{prdtCd}
	      AND A.EXC_SN    = #{excSn}
	      AND A.SCX_DCD = '02' 
	      AND NVL(PRCS_CPLT_YN, '0') = '0' 
	      AND #{dealMrdpPrca} &gt; 0 					/* 중도상환금액이 있는경우  */
	      AND B.PRDT_CD = A.PRDT_CD 
	      AND B.EXC_SN  = A.EXC_SN 
		  AND A.PRAR_DT BETWEEN B.APLY_STRT_DT  AND  B.APLY_END_DT      
		ORDER BY PRDT_CD, EXC_SN, SCX_DCD DESC, LPAD(RDMP_TMRD, 3, '0'), PAI_TYP_VAL  
    </select>

    <update id="saveRdpm" parameterType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
        <foreach collection="list" item="item" separator=";">        
          UPDATE IBIMS403B
             SET PRCS_CPLT_YN 	= #{item.prcsCpltYn} 		/* 처리완료여부 */
               , PRCS_DT 	     = #{item.prcsDt} 			/* 처리일자 */
               , PRCS_AMT 		= #{item.prcsAmt} 			/* 처리금액 */
               , PRCS_INTR_AMT 	= #{item.prcsIntrAmt} 		/* 처리이자금액 */
               , APLY_IRT 		= #{item.aplyIrt} 			/* 적용이율 */
               , OVDU_INTR_RT 	= #{item.ovduIntrRt} 		/* 연체이자율 */
               , TRCH_DCD 		= #{item.trchDcd} 			/* 트렌치구분코드 */
               , TR_SN 		     = NVL(#{item.trSn},0)	     /* 거래일련번호 */
               , HND_DETL_DTM 	= SYSDATE			  		/* 조작상세일시 */
           WHERE PRDT_CD           = #{item.prdtCd}  	          /* 상품코드 */
             AND EXC_SN            = #{item.excSn}               /* 실행일련번호 */
             AND SCX_DCD           = #{item.scxDcd} 	          /* 일정구분코드 */
             AND RDMP_TMRD         = #{item.rdmpTmrd}            /* 상환회차 */
		</foreach>
    </update>

    <update id="saveIBIMS403B" parameterType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
          UPDATE IBIMS403B
             SET PRCS_CPLT_YN 	= #{prcsCpltYn} 		/* 처리완료여부 */
               , PRCS_DT 	    = #{prcsDt} 			/* 처리일자 */
               , PRCS_AMT 		= #{prcsAmt} 			/* 처리금액 */
               , PRCS_INTR_AMT 	= #{prcsIntrAmt} 		/* 처리이자금액 */
               , APLY_IRT 		= NVL(#{aplyIrt}   , APLY_IRT)	/* 적용이율 */
               , OVDU_INTR_RT 	= NVL(#{ovduIntrRt}, OVDU_INTR_RT) 		/* 연체이자율 */
               , TRCH_DCD 		= NVL(#{trchDcd}, TRCH_DCD)		/* 트렌치구분코드 */
               , TR_SN 		    = NVL(#{trSn},0)	    /* 거래일련번호 */
               , HND_DETL_DTM 	= SYSDATE			 	/* 조작상세일시 */
           WHERE PRDT_CD        = #{prdtCd}  	    	/* 상품코드 */
             AND EXC_SN         = #{excSn}           	/* 실행일련번호 */
             AND SCX_DCD        = #{scxDcd} 	        /* 일정구분코드 */
             AND RDMP_TMRD      = #{rdmpTmrd}        	/* 상환회차 */
    </update>


     <!-- /*TB06015P */ 원금상환 계획 정보 조회 -->
     <select id='getRdmpSchedule' parameterType="com.nanuri.rams.business.common.vo.TB06015SVO" resultType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
          SELECT A.PRDT_CD                /* 종목코드 */
               , A.RDMP_TMRD              /* 상환회차 */
               , A.PRAR_DT                /* 예정일자 */
               , A.PRAR_PRNA              /* 예정원금 */
               , A.STRT_DT                /* 시작일자 */
               , A.END_DT                 /* 종료일자 */
               , A.PRCS_CPLT_YN           /* 처리여부 */
               , A.PRCS_DT                /* 처리일시 */
               , A.EXC_SN                 /* 실행일련번호 */
            FROM IBIMS403B A
           WHERE PRDT_CD = #{prdtCd}
          <if test="excSn != null and excSn != ''">
             AND EXC_SN = #{excSn}
          </if>
             AND SCX_DCD  = '02'
           ORDER BY STRT_DT ASC
     </select>

     <!-- /*TB06015P */ 이자상환 계획 정보 조회 -->
     <select id='getIntrSchedule' parameterType="com.nanuri.rams.business.common.vo.TB06015SVO" resultType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
          SELECT A.PRDT_CD                /* 종목코드 */
               , A.RDMP_TMRD              /* 상환회차 */
               , A.PRAR_DT                /* 예정일자 */
               , A.RDMP_PRAR_INTR         /* 상환예정이자 */
               , A.STRT_DT                /* 시작일자 */
               , A.END_DT                 /* 종료일자 */
               , A.PRAR_PRNA              /* 예정원금 */
               , A.APLY_IRT               /* 적용이율 */
               , A.PRCS_CPLT_YN           /* 처리여부 */
               , A.PRCS_DT                /* 처리일시 */
               , A.EXC_SN                 /* 실행일련번호 */
            FROM IBIMS403B A
           WHERE PRDT_CD = #{prdtCd}
          <if test="excSn != null and excSn != ''">
             AND EXC_SN = #{excSn}
          </if>
             AND SCX_DCD  = '04'
           ORDER BY STRT_DT ASC
     </select>

     <!-- /*TB07050S */ 실행스케줄 조회 -->
     <select id='getExcSchedule' parameterType="com.nanuri.rams.business.common.vo.TB06015SVO" resultType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
          SELECT PRDT_CD                /* 종목코드 */
               , RDMP_TMRD              /* 상환회차 */
               , PRAR_DT                /* 예정일자 */
               , PRAR_PRNA              /* 예정원금 */
               , PRCS_CPLT_YN           /* 처리여부 */
               , PRCS_DT                /* 처리일시 */
               , EXC_SN                 /* 실행일련번호 */
            FROM IBIMS403B A
           WHERE PRDT_CD = #{prdtCd}
             AND SCX_DCD  = '01'
           ORDER BY PRAR_DT DESC
     </select>

     <!-- /*여신스케쥴기본등록 */  -->
     <insert id="insertCrdlSchBss" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
        INSERT INTO IBIMS403B
               (
                  PRDT_CD                                 <!-- /*상품코드 */ -->
                , EXC_SN                                  <!-- /*실행일련번호 */ -->
                , SCX_DCD                                 <!-- /*일정구분코드 */ -->
                , RDMP_TMRD                               <!-- /*상환회차 */ -->
                , PRAR_DT                                 <!-- /*예정일자 */ -->
                , PRAR_PRNA                               <!-- /*예정원금 */ -->
                , STRT_DT                                 <!-- /*시작일자 */ -->
                , END_DT                                  <!-- /*종료일자 */ -->
                , RDMP_PRAR_INTR                          <!-- /*상환예정이자 */ -->
                , PRCS_CPLT_YN                            <!-- /*처리완료여부 */ -->
                , PRCS_DT                                 <!-- /*처리일자 */ -->
                , PRCS_AMT                                <!-- /*처리금액 */ -->
                , PRCS_INTR_AMT                           <!-- /*처리이자금액 */ -->
                , APLY_IRT                                <!-- /*적용이율 */ -->
                , OVDU_INTR_RT                            <!-- /*연체이자율 */ -->
                , TRCH_DCD                                <!-- /*트렌치구분코드 */ -->
                , TR_SN                                   <!-- /*거래일련번호 */ -->
                , HND_DETL_DTM                            <!-- /*조작상세일시 */ -->
                , HND_EMPNO                               <!-- /*조작사원번호 */ -->
                , HND_TMNL_NO                             <!-- /*조작단말기번호 */ -->
                , HND_TR_ID                               <!-- /*조작거래id */ -->
                , GUID                                    <!-- /*guid */ -->
               )
        VALUES
               (
                 #{prdtCd}                           <!-- /*상품코드 */ -->
               , #{excSn}                            <!-- /*실행일련번호 */ -->
               , #{scxDcd}                           <!-- /*일정구분코드 */ -->
               , #{rdmpTmrd}                         <!-- /*상환회차 */ -->
               , #{prarDt}                           <!-- /*예정일자 */ -->
               , #{prarPrna}                         <!-- /*예정원금 */ -->
               , #{strtDt}                           <!-- /*시작일자 */ -->
               , #{endDt}                            <!-- /*종료일자 */ -->
               , #{rdmpPrarIntr}                     <!-- /*상환예정이자 */ -->
               , #{prcsCpltYn}                       <!-- /*처리완료여부 */ -->
               , TO_CHAR(SYSDATE, 'YYYYMMDD')         <!-- /*처리일자 */ -->
               , #{prcsAmt}                          <!-- /*처리금액 */ -->
               , #{prcsIntrAmt}                      <!-- /*처리이자금액 */ -->
               , #{aplyIrt}                          <!-- /*적용이율 */ -->
               , #{ovduIntrRt}                       <!-- /*연체이자율 */ -->
               , #{trchDcd}                          <!-- /*트렌치구분코드 */ -->
               , #{trSn}                             <!-- /*거래일련번호 */ -->
               , SYSDATE                               <!-- /*조작상세일시 */ -->
               , #{hndEmpno}                         <!-- /*조작사원번호 */ -->
               , #{hndTmnlNo}                        <!-- /*조작단말기번호 */ -->
               , #{hndTrId}                          <!-- /*조작거래id */ -->
               , #{guid}                             <!-- /*guid */ -->
               )
     </insert>

     <!-- /*원리금 */ 스케줄관리 업데이트 -->
     <update  id="updateCrdlSchBss" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
          UPDATE IBIMS403B
             SET PRAR_DT           = #{prarDt}                     /* 예정일자 */  
               , PRAR_PRNA         = #{prarPrna}                   /* 예정원금 */
               , STRT_DT           = #{strtDt}                     /* 시작일자 */
               , END_DT            = #{endDt}                      /* 종료일자 */
               , RDMP_PRAR_INTR    = #{rdmpPrarIntr}               /* 상환예정이자 */
               , PRCS_CPLT_YN 	   = #{prcsCpltYn} 		             /* 처리완료여부 */
               , PRCS_DT 	         = TO_CHAR(SYSDATE, 'YYYYMMDD')  /* 처리일자 */
               , PRCS_AMT 		     = #{prcsAmt} 			             /* 처리금액 */
               , PRCS_INTR_AMT 	   = #{prcsIntrAmt} 	    	       /* 처리이자금액 */
               , APLY_IRT 		     = #{aplyIrt} 			             /* 적용이율 */
               , OVDU_INTR_RT 	   = #{ovduIntrRt} 		             /* 연체이자율 */
               , TRCH_DCD 		     = #{trchDcd} 			             /* 트렌치구분코드 */
               , TR_SN 		         = NVL(#{trSn},0)	           /* 거래일련번호 */
               , HND_DETL_DTM 	   = SYSDATE 		       /* 조작상세일시 */
           WHERE PRDT_CD           = #{prdtCd}  	                 /* 상품코드 */
             AND EXC_SN            = #{excSn}                      /* 실행일련번호 */
             AND SCX_DCD           = #{scxDcd} 	                   /* 일정구분코드 */
             AND RDMP_TMRD         = #{rdmpTmrd}                   /* 상환회차 */
     </update>

     <!-- /*원리금 */ 스케줄관리 실행일련번호 조회 -->
     <select id="srchExcSn" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO" resultType="java.util.HashMap">
          SELECT DISTINCT(EXC_SN)              /* 실행일련번호 */
            FROM IBIMS403B
           WHERE PRDT_CD = #{prdtCd}           /* 종목코드 */
           <if test="scxDcd != null"> 
             AND SCX_DCD = #{scxDcd}           /* 일정구분코드 */
            </if>
           ORDER
              BY EXC_SN DESC
     </select>

     <!-- /*원리금 */ 스케줄관리 삭제 -->
     <delete  id="deleteCrdlSchBss" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO">
          DELETE 
            FROM IBIMS403B
           WHERE PRDT_CD   = #{prdtCd}     /* 종목코드 */
             AND RDMP_TMRD = #{rdmpTmrd}   /* 상환회차 */
             AND SCX_DCD   = #{scxDcd}     /* 일정구분코드 */
             AND EXC_SN    = #{excSn}      /* 실행일련번호 */
     </delete>


     <!-- /*원리금 */ 스케줄관리 삭제 -->
     <delete  id="deleteIBIMS403B" parameterType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
          DELETE 
            FROM IBIMS403B
           WHERE PRDT_CD   = #{prdtCd}     /* 종목코드 */
             AND EXC_SN    = #{excSn}      /* 실행일련번호 */
     </delete>
     
     <!-- /*원리금 */ 스케줄관리 회차 채번 -->
     <select id="getPaiSchTmrd" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO" resultType="String">
        SELECT TO_CHAR(MAX(TO_NUMBER(NVL(RDMP_TMRD, 0))) + 1 ) AS rdmpTmrd /* 상환회차 */
          FROM IBIMS403B
         WHERE PRDT_CD = #{prdtCd}     /* 종목코드 */
           AND SCX_DCD = #{scxDcd}     /* 일정구분코드 */
           AND EXC_SN  = #{excSn}      /* 실행일련번호 */
     </select>

     <!-- /*실행 */ 스케줄관리 실행일련번호 채번 -->
     <select id="getExcSchExcSn" parameterType="com.nanuri.rams.business.common.dto.IBIMS403BDTO" resultType="long">
        SELECT NVL(MAX(NVL(NULLIF(EXC_SN, 0), 0)), 0) + 1 AS EXC_SN
          FROM IBIMS403B
         WHERE PRDT_CD  = #{prdtCd}
           AND SCX_DCD  = #{scxDcd}
     </select>

    <!--입금내역관리 상환예정내역 조회-->
    <select id="getRdmpPrarDtls" parameterType="com.nanuri.rams.business.common.vo.IBIMS430BVO" resultType="com.nanuri.rams.business.common.vo.IBIMS403BVO">
  SELECT  CASE  WHEN P.SCX_DCD = '02'
                      THEN P.PRAR_PRNA
                      ELSE P.RDMP_PRAR_INTR
                    END                   AS 		PMNT_PRAR_AMT					/*납부예정금액*/
                    , P.PRAR_DT 				                              /*상환예정일자*/
                    , D1.DEAL_NO 				                              /*딜번호*/
                    , D1.MNGM_BDCD 			                              /*관리부서*/
                    , P.SCX_DCD 				                              /*상환구분*/
                    , D1.TR_CRRY_CD 			                            /*통화코드*/
                FROM IBIMS403B P				                              /*원리금상환스케줄*/
                	, IBIMS201B D1 
                WHERE 1=1
                AND D1.PRDT_CD = P.PRDT_CD
                AND D1.LAST_YN = '1'
                AND (P.PRCS_CPLT_YN != '1' OR P.PRCS_CPLT_YN IS NULL)
                <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(dealNo)">
                  AND D1.DEAL_NO  = #{dealNo}
                </if>
                <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(dprtCd)">
                  AND D1.MNGM_BDCD = #{dprtCd}
                </if>
                <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(fromDt)">
                  AND P.PRAR_DT &gt;= #{fromDt} 
                </if>
                <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(toDt)">
                  AND P.PRAR_DT &lt;= #{toDt} 
                </if>
                UNION ALL
                SELECT   F.FEE_AMT				AS PMNT_PRAR_AMT	          /*납부예정금액*/
                    , F.PRAR_DT                                       /*상환예정일자*/
                    , D2.DEAL_NO                                      /*딜번호*/
                    , D2.MNGM_BDCD                                    /*관리부서*/
                    , '03'					      AS SCX_DCD                  /*상환구분*/
                    , D2.TR_CRRY_CD                                   /*통화코드*/
                FROM IBIMS348B F                                      /*수수료상환스케줄*/
                	, IBIMS201B D2                  
                WHERE 1=1
                AND D2.PRDT_CD = F.PRDT_CD
                AND D2.LAST_YN = '1'
                AND (F.PRCS_CPLT_YN != '1' OR F.PRCS_CPLT_YN IS NULL)
                <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(dealNo)">
                  AND D2.DEAL_NO  = #{dealNo}
                </if>
                <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(dprtCd)">
                  AND D2.MNGM_BDCD = #{dprtCd}
                </if>
                <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(fromDt)">
                  AND F.PRAR_DT &gt;= #{fromDt} 
                </if>
                <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(toDt)">
                  AND F.PRAR_DT &lt;= #{toDt} 
                </if>
                ORDER BY PRAR_DT 
    </select>

    <!--상환대상내역 조회-->
    <select id="rdmpTrgtDtlsInq" parameterType="com.nanuri.rams.business.common.vo.TB09070SVO" resultType="com.nanuri.rams.business.common.vo.TB09070SVO$RdmpTrgtDtlsVO">
      SELECT    A.PRAR_PRNA                     AS PRAR_PRNA                         /*상환예정원금*/
              , A.RDMP_PRAR_INTR                AS RDMP_PRAR_INTR            /*상환예정이자*/          
              , A.PMNT_PRAR_AMT 				AS PMNT_PRAR_AMT		   /*납부예정금액*/		
              , CASE WHEN LENGTH(A.PRAR_DT)=8 
				THEN TO_CHAR(TO_DATE(A.PRAR_DT, 'YYYYMMDD'), 'YYYY-MM-DD') 
				ELSE '' END AS PRAR_DT     /*예정일자*/     
              , B.ACTS_CD 						/*계정과목코드*/
              , B.MNGM_BDCD 					/*관리부점코드*/
              , C.ORTN_FND_CD 				/*운용펀드코드*/
              , (SELECT fnd.FND_NM
                FROM IBIMS993B fnd
                WHERE fnd.FND_CD = C.ORTN_FND_CD) AS FND_NM 					/*운용펀드명*/
              , C.TR_CRRY_CD 					/*통화코드*/
              , C.DEAL_NO 						/*딜번호*/
              , C.DEAL_NM             /*딜명*/
              , C.PRDT_NM 						/*상품명*/
              , D.TR_OBJT_BSN_NO 			/*거래대상기업체번호*/
        FROM ( SELECT 
        		A.PRAR_DT, A.PRDT_CD, A.EXC_SN
        	  , SUM(COALESCE(A.PRAR_PRNA, 0))                        AS PRAR_PRNA                        
              , SUM(COALESCE(A.RDMP_PRAR_INTR, 0))                  AS RDMP_PRAR_INTR                     
              , (SUM(COALESCE(A.PRAR_PRNA, 0)) + SUM(COALESCE(A.RDMP_PRAR_INTR, 0))) AS PMNT_PRAR_AMT	      
        	FROM IBIMS403B A 
        	 GROUP BY A.PRAR_DT, A.PRDT_CD, A.EXC_SN
        	) A
        	, IBIMS401B B 
            , IBIMS201B C
            , IBIMS410B D
        WHERE 1=1
        AND D.PRDT_CD = A.PRDT_CD 
        AND D.EXC_SN = A.EXC_SN 
        AND C.PRDT_CD = A.PRDT_CD 
        AND C.LAST_YN = '1'
        AND B.PRDT_CD = A.PRDT_CD
        <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(mngmBdcd)">
        AND B.MNGM_BDCD = #{mngmBdcd}
        </if>
        <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(actsCd)">
        AND B.ACTS_CD = #{actsCd}
        </if>
        <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(dealNo)">
        AND C.DEAL_NO = #{dealNo}
        </if>
        <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(trObjtBsnNo)">
        AND D.TR_OBJT_BSN_NO = #{trObjtBsnNo}
        </if>
        <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(fromDt)">
        AND A.PRAR_DT &gt;= #{fromDt} 
        </if>
        <if test="@com.nanuri.rams.com.utils.MybatisCheck@notEmpty(toDt)">
        AND A.PRAR_DT &lt;= #{toDt} 
        </if>

    </select>
</mapper>